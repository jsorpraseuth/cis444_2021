<!DOCTYPE html>
<html>
    <head>
	     <script src="https://code.jquery.com/jquery-3.6.0.js" 
		     integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	     <script src="/static/cis444.js"></script>
		 <link rel="stylesheet" href="/static/styles.css">
    </head>
	
    <body>

		<script>

			var pulledBooks;

			function logout() {
				// empty books table
				pulledBooks.innerHTML = "";
				
				// delete session token
				fetch("/logout");
				jwt = undefined;
				
				// hide store show login page
				$("#login").show();
				$("#store").hide();
			}

			function verify() {
				$.post("/open_api/login", {"username" : $('#username').val(), "password" : $('#password').val()},
					function(data, textStatus) {
						if(data.authenticated == false) {
							alert(data.message);
							return false;
						}
						//this gets called when browser receives response from server
						console.log("Token: " + data.token);
						// store jwt
						jwt = data.token
						//make secure call with the jwt
						loadBooks();
					}, "json").fail(function(response) {
						//this gets called if the server throws an error
						console.log("error");
						console.log(response);
					});

				return true;
			}

			function loadBooks() {	
				secure_get_with_token("/secure_api/get_books", {} , function(data) {
					console.log("got books"); 
					console.log(data);
					
					$("#login").hide();
					$('#store').show();
					
					// display books
					for(i = 0; i < data.books.length; i++) {
					// <button id="book_id" onclick="buyBook(this.id);">Buy</button>
						pulledBooks = document.getElementById("books");
						pulledBooks.insertAdjacentHTML('beforeend', '<tr><td><button id="' + 
						response.data.books[i].book_id + '" onclick="buyBook(this.id);">Buy</button></td>'
						+ '<td><strong class="bookTitle">' + response.data.books[i].book_name 
						+ '</strong> by ' + response.data.books[i].book_author + '</td>'
						+ '<td>' + response.data.books[i].book_genre + '</td>'
						+ '<td>$ ' + response.data.books[i].book_price + '</td></tr>');
					}
				},
					function(err){ console.log(err) });
			}

			async function buyBook(id) {
				const response = await $.post("/buyBook", { "jwt": token.jwt, "book_id": id }, "json");
				alert(response.message);
			}

			function buy_book(book_id){
				//make secure call with the jwt
				secure_get_with_token("/secure_api/get_books", {"book_id" : book_id} , function(data) {
					console.log("bought book"); console.log(data)
				},
				function(err){ console.log(err) });
			}

		</script>
		
		<div id="store">
			<input id="logOut" type="submit" value="Log Out" onclick="logout()">
			<table>
			<h1>Store Page</h1>
				<thead>
				<tr>
					<th></th>
					<th scope="col">Book</th>
					<th>Genre</th>
					<th>Price</th>
				</tr>
				</thead>
				<tbody id="books">
				</tbody>
			</table>
		</div>
		
		<div id="login">
			<h1 id="formHeader">Log In</h1>
			<label class="formLabel" for="username">Username</label>
			<input class="formInput" type="text" id="username" name="username" placeholder="Username" required>
			
			<label class="formLabel" for="password">Password</label>
			<input class="formInput" type="password" id="password" name="password" placeholder="Password" required>
			
			<p id="registerForm">Don't have an account? <a href="#" onclick="registerForm()">Click here to sign up.</a></p>
			<p id="loginForm">Already have an account? <a href="#" onclick="loginForm()">Click here to log in.</a></p>
			
			<input id="formSubmit" type="submit" value="Log In" onclick="return verify();">
			
		</div>
		
		<script src="/static/forms.js"></script>
    </body>
</html>

